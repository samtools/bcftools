include::header.inc[]


Consensus sequence
------------------

Sometimes there is the need to create a consensus sequence for an individual
where the sequence incorporates variants typed for this individual.
This is possible using the ``consensus`` command.

We need the reference sequence ``reference.fa`` in the fasta format
and an indexed VCF with the variants ``calls.bcf``. The command is:

----
cat reference.fa | bcftools consensus calls.vcf.gz > consensus.fa
----

This assumes we have already made the calls, normalized indels and filtered. There is
link:variant-calling.html[another page] which goes deeper and is devoted just
to this, but in brief, the variant calling command in its simplest form is:

----
# Call variants
bcftools mpileup -Ou -f reference.fa alignments.bam | bcftools call -mv -Oz -o calls.vcf.gz
bcftools index calls.vcf.gz

# Normalize indels
bcftools norm -f reference.fa calls.vcf.gz -Ob -o calls.norm.bcf

# Filter adjacent indels within 5bp and variants with quality lower than 40.
# Important:
#   This is just an example, proper filtering is much more involved;
#   filtered only like this, the callset will contain many false positives.
bcftools filter --IndelGap 5 -e 'QUAL<40' calls.norm.bcf -Ob -o calls.norm.flt.bcf

# Apply variants to create consensus sequence
cat reference.fa | bcftools consensus calls.norm.flt.vcf.gz > consensus.fa

# The examples below are just to show the program access various options that modify its
# behavior. For the full list of options, see the manual page.

# Output IUPAC ambiguity codes based on REF+ALT columns (regardless of genotype)
cat reference.fa | bcftools consensus --iupac-codes calls.norm.flt.vcf.gz > consensus.fa

# Output IUPAC ambiguity codes based on sample genotypes
cat reference.fa | bcftools consensus --haplotype I calls.norm.flt.vcf.gz > consensus.fa
----

*Note:* in order to keep the program relatively simple,
``consensus`` merely applies variants from the VCF regardless of AF or other properties.
If more more advanced logic
is required, the VCF has to be preprocessed with other tools, such as the ``+setGT`` plugin
(see an example link:https://github.com/samtools/bcftools/issues/1516[here]).



include::footer.inc[]


