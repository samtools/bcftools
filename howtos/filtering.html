<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.23">
<title>Filtering</title>
<link rel="stylesheet" href="./index.css">
</head>
<body class="article">
<div id="header">
</div>
<div id="content">
<div class="sidebarblock navig">
<div class="content">
<div class="ulist">
<div class="title">General</div>
<ul>
<li>
<p><a href="index.html">Main page</a></p>
</li>
<li>
<p><a href="../bcftools.html">Manual page</a></p>
</li>
<li>
<p><a href="install.html">Installation</a></p>
</li>
<li>
<p><a href="publications.html">Publications</a></p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Calling</div>
<ul>
<li>
<p><a href="cnv-calling.html">CNV calling</a></p>
</li>
<li>
<p><a href="csq-calling.html">Consequence calling</a></p>
</li>
<li>
<p><a href="consensus-sequence.html">Consensus calling</a></p>
</li>
<li>
<p><a href="roh-calling.html">ROH calling</a></p>
</li>
<li>
<p><a href="variant-calling.html">Variant calling and filtering</a></p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Tips and Tricks</div>
<ul>
<li>
<p><a href="convert.html">Converting formats</a></p>
</li>
<li>
<p><a href="annotate.html">Adding annotation</a></p>
</li>
<li>
<p><a href="query.html">Extracting information</a></p>
</li>
<li>
<p><a href="filtering.html">Filtering expressions</a></p>
</li>
<li>
<p><a href="scaling.html">Performance and Scaling</a></p>
</li>
<li>
<p><a href="plugins.html">Plugins</a></p>
</li>
<li>
<p><a href="FAQ.html">FAQ</a></p>
</li>
</ul>
</div>
</div>
</div>
<div id="main">
<div class="sect1">
<h2 id="_filtering">Filtering</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Most BCFtools commands accept the <code>-i, --include</code> and <code>-e, --exclude</code> options
which allow advanced filtering. In the examples below, we demonstrate the
usage on the <code>query</code> command because it allows us to show the output in
a very compact form using the <code>-f</code> formatting option. (For details about
the format, see the <a href="query.html">Extracting information</a> page.)</p>
</div>
<div class="paragraph">
<div class="title"><strong>Simple example: filtering by fixed columns</strong></div>
<p>Fixed columns such as QUAL, FILTER, INFO are straightforward to filter. In this example,
we use the <code>-e 'FILTER="."'</code> expression to exclude sites where FILTER is not set:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ bcftools query -e'FILTER="."' -f'%CHROM %POS %FILTER\n' file.bcf | head -2
1 3000150 PASS
1 3000151 LowQual</pre>
</div>
</div>
<div class="paragraph">
<p>In this example, we use the <code>-i 'QUAL&gt;20 &amp;&amp; DP&gt;10'</code> expression to include only sites with big enough quality and depth:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ bcftools query -i'QUAL&gt;20 &amp;&amp; DP&gt;10' -f'%CHROM %POS %QUAL %DP\n' file.bcf | head -2
1 14930 31.2757 13
1 17538 37.9458 12</pre>
</div>
</div>
<div class="paragraph">
<div class="title"><strong>FORMAT columns</strong></div>
<p>When filtering FORMAT tags, the OR logic is applied with multiple
samples. For example, if we want to remove sites with an uncalled
genotype in any sample, the expression <code>-i 'GT!="mis"'</code> is not going to work:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ bcftools view -i'GT!="mis"' file.vcf | bcftools query -f'%CHROM %POS [ %GT]\n' | head -2
1 3000150  ./. ./. 0/1 1/1
1 3000151  ./. ./. 0|0 0|0</pre>
</div>
</div>
<div class="paragraph">
<p>Instead, the reverse logic <code>-e 'GT="mis"'</code> must be applied:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ bcftools view -e'GT="mis"' file.vcf | bcftools query -f'%CHROM %POS [ %GT]\n' | head -2
1 3062915  0/1 0/1 0/1 0/1</pre>
</div>
</div>
<div class="paragraph">
<p>Note we used <code>bcftools view .. | bcftools query &#8230;&#8203;</code> to filter first by site, then format the output.
Using the same filtering expression directly with the <code>query</code> command would not work, because
<code>query</code> excludes samples that do not satisfy the filtering expression</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ bcftools query -i'GT!="mis"' f'%CHROM %POS [ %GT]\n' file.vcf | head -2
1 3000150  0/1 1/1
1 3000151  0|0 0|0

$ bcftools query -e'GT="mis"' f'%CHROM %POS [ %GT]\n' file.vcf | head -2
1 3000150  0/1 1/1
1 3000151  0|0 0|0</pre>
</div>
</div>
<div class="paragraph">
<div class="title"><strong>FORMAT columns and boolean expressions (<code>&amp;&amp;</code> vs <code>&amp;</code> and <code>||</code> vs <code>|</code>)</strong></div>
<p>Say our VCF contains the per-sample depth and genotype quality annotations
and we want to include only sites where one or more samples have big enough coverage
(<code>DP&gt;10</code>) and genotype quality (<code>GQ&gt;20</code>). The expression <code>-i 'FMT/DP&gt;10 &amp; FMT/GQ&gt;20'</code> selects
sites where the conditions are satisfied within the same sample:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ bcftools query -i'FMT/DP&gt;10 &amp; FMT/GQ&gt;20' -f'%POS[\t%SAMPLE:DP=%DP GQ=%GQ]\n' file.bcf
49979   SampleA:DP=10 GQ=50     SampleB:DP=20 GQ=40</pre>
</div>
</div>
<div class="paragraph">
<p>On the other hand, if we need to include sites where both conditions met but
not necessarily in the same sample, we use the <code>&amp;&amp;</code> operator rather than <code>&amp;</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ bcftools query -i'FMT/DP&gt;10 &amp;&amp; FMT/GQ&gt;20' -f'%POS[\t%SAMPLE:DP=%DP GQ=%GQ]\n' file.bcf
31771   SampleA:DP=10 GQ=50     SampleB:DP=40 GQ=20
49979   SampleA:DP=10 GQ=50     SampleB:DP=20 GQ=40</pre>
</div>
</div>
<div class="paragraph">
<p>Similarly, the <code>|</code> operator can select just the matching samples:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ bcftools query -f'[%POS %SAMPLE %DP\n]\n' -i'FMT/DP=19 | FMT/DP="."' test/view.filter.vcf
3162006 A 19

3162007 A .
3162007 B .</pre>
</div>
</div>
<div class="paragraph">
<p>or the whole record when <code>||</code> is used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ bcftools query -f'[%POS %SAMPLE %DP\n]\n' -i'FMT/DP=19 || FMT/DP="."' test/view.filter.vcf
3162006 A 19
3162006 B 1

3162007 A .
3162007 B .</pre>
</div>
</div>
<div class="sect2">
<h3 id="_feedback">Feedback</h3>
<div class="paragraph">
<p>We welcome your feedback, please help us improve this page by 
either opening an <a href="https://github.com/samtools/bcftools/issues">issue on github</a> or <a href="https://github.com/samtools/bcftools/tree/gh-pages/howtos">editing it directly</a> and sending
a pull request.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
</div>
</div>
</body>
</html>